# Gitea ç§æœ‰ä»“åº“é…ç½®è¯¦ç»†æŒ‡å—

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç» Gitea ç§æœ‰ Git ä»“åº“çš„éƒ¨ç½²ã€é…ç½®å’Œä¸ Jenkins çš„é›†æˆã€‚

## ğŸ“‹ ç›®å½•

- [æ–¹æ¡ˆæ¦‚è¿°](#æ–¹æ¡ˆæ¦‚è¿°)
- [Gitea å®‰è£…](#gitea-å®‰è£…)
- [Gitea åˆå§‹åŒ–](#gitea-åˆå§‹åŒ–)
- [åˆ›å»ºç§æœ‰ä»“åº“](#åˆ›å»ºç§æœ‰ä»“åº“)
- [Jenkins é›†æˆ](#jenkins-é›†æˆ)
- [ä½¿ç”¨æµç¨‹](#ä½¿ç”¨æµç¨‹)
- [ç›‘æ§å’Œç»´æŠ¤](#ç›‘æ§å’Œç»´æŠ¤)
- [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)

---

## ğŸ¯ æ–¹æ¡ˆæ¦‚è¿°

### ä¸ºä»€ä¹ˆé€‰æ‹© Giteaï¼Ÿ

- âœ… **è½»é‡çº§**ï¼šèµ„æºå ç”¨å°ï¼Œé€‚åˆå°å‹æœåŠ¡å™¨
- âœ… **åŠŸèƒ½å®Œæ•´**ï¼šæ”¯æŒ Webhookã€PRã€Issue ç­‰
- âœ… **æ˜“äºéƒ¨ç½²**ï¼šDocker ä¸€é”®éƒ¨ç½²
- âœ… **ç•Œé¢å‹å¥½**ï¼šç±»ä¼¼ GitHub çš„ç•Œé¢
- âœ… **å®Œå…¨ç§æœ‰**ï¼šæ•°æ®å®Œå…¨æŒæ§

### æ¶æ„æµç¨‹

```
æœ¬åœ°å¼€å‘ â†’ æ¨é€ä»£ç  â†’ Gitea ä»“åº“ â†’ Webhook è§¦å‘ â†’ Jenkins â†’ è‡ªåŠ¨éƒ¨ç½² â†’ æœåŠ¡å™¨
```

---

## ğŸš€ Gitea å®‰è£…

### Docker Compose å®‰è£…ï¼ˆæ¨èï¼‰

#### 1. é…ç½®ç¯å¢ƒå˜é‡

```bash
cd script/deploy
cp env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œä¿®æ”¹æœåŠ¡å™¨ IP ç­‰é…ç½®
```

#### 2. å¯åŠ¨ Gitea

```bash
docker-compose -f docker-compose-gitea.yml --env-file .env up -d
```

#### 3. éªŒè¯å®‰è£…

è®¿é—® `http://your-server-ip:3000`ï¼Œåº”è¯¥èƒ½çœ‹åˆ° Gitea å®‰è£…é¡µé¢ã€‚

---

## âš™ï¸ Gitea åˆå§‹åŒ–

### 1. é¦–æ¬¡è®¿é—®é…ç½®

1. æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š`http://your-server-ip:3000`
2. ç‚¹å‡» **"ç«‹å³å®‰è£…"**
3. é…ç½®ä»¥ä¸‹ä¿¡æ¯ï¼š

   **æ•°æ®åº“è®¾ç½®**ï¼š
   - æ•°æ®åº“ç±»å‹ï¼š`SQLite3`ï¼ˆç®€å•ï¼Œé€‚åˆå°å‹é¡¹ç›®ï¼‰
   - æˆ–é€‰æ‹© `MySQL`ï¼ˆå¦‚æœå·²æœ‰ MySQL æœåŠ¡ï¼‰

   **å¸¸è§„è®¾ç½®**ï¼š
   - ç«™ç‚¹æ ‡é¢˜ï¼š`Sidifensen Blog`
   - ä»“åº“æ ¹ç›®å½•ï¼š`/data/git/repositories`
   - Git LFS æ ¹ç›®å½•ï¼š`/data/git/lfs`
   - è¿è¡Œç”¨æˆ·åï¼š`git`
   - SSH æœåŠ¡åŸŸåï¼š`your-server-ip`
   - SSH ç«¯å£ï¼š`2222`
   - HTTP ç«¯å£ï¼š`3000`
   - åº”ç”¨ URLï¼š`http://your-server-ip:3000/`

   **å¯é€‰è®¾ç½®**ï¼š
   - ç®¡ç†å‘˜è´¦æˆ·è®¾ç½®ï¼ˆå»ºè®®è®¾ç½®ï¼‰
   - é‚®ä»¶æœåŠ¡é…ç½®ï¼ˆå¯é€‰ï¼‰

4. ç‚¹å‡» **"ç«‹å³å®‰è£…"**

### 2. åˆ›å»ºç®¡ç†å‘˜è´¦æˆ·

å¦‚æœæœªåœ¨å®‰è£…æ—¶åˆ›å»ºï¼Œå¯ä»¥ï¼š
1. æ³¨å†Œç¬¬ä¸€ä¸ªè´¦æˆ·
2. è¯¥è´¦æˆ·è‡ªåŠ¨æˆä¸ºç®¡ç†å‘˜

---

## ğŸ“¦ åˆ›å»ºç§æœ‰ä»“åº“

### 1. åˆ›å»ºæ–°ä»“åº“

1. ç™»å½• Gitea
2. ç‚¹å‡»å³ä¸Šè§’ **"+"** â†’ **"æ–°å»ºä»“åº“"**
3. å¡«å†™ä»“åº“ä¿¡æ¯ï¼š
   - **ä»“åº“åç§°**ï¼š`sidifensen_blog`
   - **ä»“åº“æè¿°**ï¼š`Sidifensen Blog Project`
   - **å¯è§æ€§**ï¼šé€‰æ‹© **"ç§æœ‰"** â­
   - **åˆå§‹åŒ–ä»“åº“**ï¼šå¯ä»¥å‹¾é€‰æ·»åŠ  README
4. ç‚¹å‡» **"åˆ›å»ºä»“åº“"**

### 2. é…ç½®ä»“åº“è®¿é—®

#### æ–¹å¼ä¸€ï¼šHTTPSï¼ˆæ¨èï¼‰

```bash
# åœ¨æœ¬åœ°é¡¹ç›®ç›®å½•æ‰§è¡Œ
git remote add gitea http://your-server-ip:3000/username/sidifensen_blog.git

# æ¨é€ä»£ç 
git push gitea main
```

#### æ–¹å¼äºŒï¼šSSH

```bash
# é…ç½® SSHï¼ˆç«¯å£ 2222ï¼‰
git remote add gitea ssh://git@your-server-ip:2222/username/sidifensen_blog.git

# æ¨é€ä»£ç 
git push gitea main
```

**æ³¨æ„**ï¼šå¦‚æœä½¿ç”¨ SSHï¼Œéœ€è¦åœ¨ Gitea ä¸­æ·»åŠ  SSH å…¬é’¥ï¼š
1. è¿›å…¥ **è®¾ç½®** â†’ **SSH / GPG å¯†é’¥**
2. ç‚¹å‡» **"æ·»åŠ å¯†é’¥"**
3. ç²˜è´´ä½ çš„ SSH å…¬é’¥å†…å®¹

---

## ğŸ”— Jenkins é›†æˆ

### 1. å®‰è£… Gitea æ’ä»¶

1. è¿›å…¥ Jenkinsï¼š`Manage Jenkins` â†’ `Plugins`
2. æœç´¢å¹¶å®‰è£…ï¼š**Gitea Plugin**
3. é‡å¯ Jenkinsï¼ˆå¦‚æœéœ€è¦ï¼‰

### 2. é…ç½® Gitea æœåŠ¡å™¨

1. è¿›å…¥ `Manage Jenkins` â†’ `Configure System`
2. æ‰¾åˆ° **Gitea Servers** éƒ¨åˆ†
3. ç‚¹å‡» **"Add Gitea Server"**
4. é…ç½®ï¼š
   - **Server URL**: `http://your-server-ip:3000`
   - **Display Name**: `Gitea Server`
   - **Credentials**: ç‚¹å‡» **"Add"** åˆ›å»ºå‡­æ®
     - **Kind**: `Gitea API Token`
     - **Token**: åœ¨ Gitea ä¸­ç”Ÿæˆ API Tokenï¼ˆè§ä¸‹æ–¹ï¼‰
     - **Description**: `Gitea API Token`

#### ç”Ÿæˆ Gitea API Token

1. ç™»å½• Gitea
2. è¿›å…¥ **è®¾ç½®** â†’ **åº”ç”¨** â†’ **ç”Ÿæˆæ–°ä»¤ç‰Œ**
3. ä»¤ç‰Œåç§°ï¼š`Jenkins`
4. æƒé™ï¼šå‹¾é€‰ `read:repository`, `read:user`
5. ç‚¹å‡» **"ç”Ÿæˆä»¤ç‰Œ"**
6. **å¤åˆ¶ä»¤ç‰Œ**ï¼ˆåªæ˜¾ç¤ºä¸€æ¬¡ï¼‰

### 3. é…ç½® Webhook

#### åœ¨ Gitea ä¸­é…ç½®

1. è¿›å…¥ä»“åº“ï¼š`sidifensen_blog`
2. ç‚¹å‡» **è®¾ç½®** â†’ **Webhooks**
3. ç‚¹å‡» **"æ·»åŠ  Webhook"** â†’ **"Gitea"**
4. é…ç½® Webhookï¼š
   - **ç›®æ ‡ URL**: `http://jenkins-server-ip:8080/gitea-webhook/post`
   - **HTTP æ–¹æ³•**: `POST`
   - **POST Content Type**: `application/json`
   - **è§¦å‘äº‹ä»¶**ï¼š
     - âœ… **æ¨é€äº‹ä»¶**ï¼ˆå¿…é¡»ï¼‰
     - âœ… **åˆ›å»ºäº‹ä»¶**ï¼ˆå¯é€‰ï¼‰
     - âœ… **åˆ é™¤äº‹ä»¶**ï¼ˆå¯é€‰ï¼‰
   - **æ¿€æ´»**: âœ… å‹¾é€‰
5. ç‚¹å‡» **"æ·»åŠ  Webhook"**

#### åœ¨ Jenkins ä¸­é…ç½®ä»»åŠ¡

1. è¿›å…¥ Jenkins ä»»åŠ¡ï¼š`sidifensen-blog-deploy`
2. ç‚¹å‡» **é…ç½®**
3. åœ¨ **æ„å»ºè§¦å‘å™¨** éƒ¨åˆ†ï¼š
   - âœ… å‹¾é€‰ **"Gitea webhook trigger for GITScm polling"**
   - æˆ–é€‰æ‹© **"Build when a change is pushed to Gitea"**
4. ä¿å­˜é…ç½®

---

## ğŸ”„ ä½¿ç”¨æµç¨‹

### æ—¥å¸¸å¼€å‘æµç¨‹

1. **æœ¬åœ°å¼€å‘**
   ```bash
   # åœ¨æœ¬åœ°è¿›è¡Œå¼€å‘
   git add .
   git commit -m "feat: æ–°åŠŸèƒ½"
   ```

2. **æ¨é€åˆ° Gitea**
   ```bash
   # æ¨é€åˆ° Gitea ç§æœ‰ä»“åº“
   git push gitea main
   ```

3. **è‡ªåŠ¨è§¦å‘éƒ¨ç½²**
   - Gitea æ”¶åˆ°æ¨é€
   - Webhook è§¦å‘ Jenkins
   - Jenkins è‡ªåŠ¨æ‰§è¡Œ Pipeline
   - è‡ªåŠ¨éƒ¨ç½²åˆ°æœåŠ¡å™¨

4. **æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€**
   - åœ¨ Jenkins ä¸­æŸ¥çœ‹æ„å»ºæ—¥å¿—
   - æ£€æŸ¥éƒ¨ç½²æ˜¯å¦æˆåŠŸ

---

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### æŸ¥çœ‹ Gitea æ—¥å¿—

```bash
# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker logs -f sidifensen-gitea

# æŸ¥çœ‹ Gitea åº”ç”¨æ—¥å¿—
docker exec sidifensen-gitea tail -f /data/gitea/log/gitea.log
```

### å¤‡ä»½å’Œæ¢å¤

#### å¤‡ä»½

```bash
# å¤‡ä»½æ•°æ®å·
docker run --rm \
  -v sidifensen-gitea-data:/data \
  -v $(pwd):/backup \
  alpine tar czf /backup/gitea-backup-$(date +%Y%m%d).tar.gz /data
```

#### æ¢å¤

```bash
# æ¢å¤æ•°æ®å·
docker run --rm \
  -v sidifensen-gitea-data:/data \
  -v $(pwd):/backup \
  alpine tar xzf /backup/gitea-backup-YYYYMMDD.tar.gz -C /
```

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: æ— æ³•è®¿é—® Gitea

**æ£€æŸ¥**ï¼š
1. å®¹å™¨æ˜¯å¦è¿è¡Œï¼š`docker ps | grep gitea`
2. ç«¯å£æ˜¯å¦å¼€æ”¾ï¼š`netstat -tlnp | grep 3000`
3. é˜²ç«å¢™è®¾ç½®

### é—®é¢˜ 2: Webhook æœªè§¦å‘

**æ£€æŸ¥**ï¼š
1. Gitea Webhook é…ç½®æ˜¯å¦æ­£ç¡®
2. Jenkins Gitea æ’ä»¶æ˜¯å¦å®‰è£…
3. Jenkins ä»»åŠ¡æ˜¯å¦é…ç½®äº†è§¦å‘å™¨
4. æŸ¥çœ‹ Gitea Webhook æ—¥å¿—ï¼ˆåœ¨ Webhook è®¾ç½®é¡µé¢ï¼‰

### é—®é¢˜ 3: æ¨é€ä»£ç å¤±è´¥

**æ£€æŸ¥**ï¼š
1. ä»“åº“ URL æ˜¯å¦æ­£ç¡®
2. è®¤è¯ä¿¡æ¯æ˜¯å¦æ­£ç¡®
3. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸

---

## ğŸ”’ å®‰å…¨é…ç½®

### 1. ä¿®æ”¹é»˜è®¤ç«¯å£ï¼ˆé‡è¦ï¼‰

**é£é™©**ï¼šé»˜è®¤ç«¯å£ `3000` å’Œ `2222` å®¹æ˜“è¢«æ‰«æå’Œæ”»å‡»ã€‚

**å»ºè®®**ï¼šä¿®æ”¹ä¸ºéæ ‡å‡†ç«¯å£

åœ¨ `.env` ä¸­ä¿®æ”¹ï¼š
```bash
# ä¿®æ”¹ä¸ºéæ ‡å‡†ç«¯å£ï¼Œé™ä½è¢«æ‰«æé£é™©
GITEA_PORT=30001        # åŸé»˜è®¤ 3000
GITEA_SSH_PORT=22222    # åŸé»˜è®¤ 2222
```

**æ³¨æ„**ï¼šä¿®æ”¹ç«¯å£åï¼Œéœ€è¦æ›´æ–°ï¼š
- Jenkins ä¸­çš„ Gitea æœåŠ¡å™¨ URL
- Webhook é…ç½®ä¸­çš„ URL
- æœ¬åœ° Git è¿œç¨‹ä»“åº“åœ°å€

### 2. ç¦æ­¢å…¬å¼€æ³¨å†Œ

åœ¨ `.env` ä¸­è®¾ç½®ï¼š
```bash
GITEA_DISABLE_REGISTRATION=true
```

### 3. é…ç½®é˜²ç«å¢™ï¼ˆå¼ºçƒˆæ¨èï¼‰

```bash
# æ–¹å¼ä¸€ï¼šä½¿ç”¨ iptables é™åˆ¶è®¿é—®
# åªå…è®¸ç‰¹å®š IP è®¿é—®ï¼ˆæ¨èï¼‰
sudo iptables -A INPUT -p tcp --dport 30001 -s å…è®¸çš„IP -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 30001 -j DROP

# æ–¹å¼äºŒï¼šä½¿ç”¨äº‘æœåŠ¡å•†å®‰å…¨ç»„
# åœ¨äº‘æ§åˆ¶å°é…ç½®å®‰å…¨ç»„è§„åˆ™ï¼Œåªå…è®¸ç‰¹å®š IP è®¿é—®

# æ–¹å¼ä¸‰ï¼šä»…å†…ç½‘è®¿é—®ï¼ˆæœ€å®‰å…¨ï¼‰
# å¦‚æœ Gitea åªåœ¨å†…ç½‘ä½¿ç”¨ï¼Œä¸è¦æš´éœ²åˆ°å…¬ç½‘
# ä½¿ç”¨ VPN æˆ–è·³æ¿æœºè®¿é—®
```

### 4. ä½¿ç”¨ HTTPSï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»ï¼‰

é…ç½® Nginx åå‘ä»£ç†ï¼Œä½¿ç”¨ HTTPS è®¿é—® Giteaã€‚

**ä¸ºä»€ä¹ˆé‡è¦**ï¼š
- HTTP æ˜æ–‡ä¼ è¾“ï¼Œå¯†ç å’Œä»£ç å¯èƒ½è¢«çªƒå–
- HTTPS åŠ å¯†ä¼ è¾“ï¼Œä¿æŠ¤æ•°æ®å®‰å…¨

### 5. å¼ºå¯†ç å’Œ SSH å¯†é’¥

- ä½¿ç”¨å¤æ‚å¯†ç ï¼ˆè‡³å°‘ 12 ä½ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—ã€ç‰¹æ®Šå­—ç¬¦ï¼‰
- ä¼˜å…ˆä½¿ç”¨ SSH å¯†é’¥è®¤è¯ï¼Œç¦ç”¨å¯†ç ç™»å½•ï¼ˆå¦‚æœå¯èƒ½ï¼‰
- å®šæœŸæ›´æ¢å¯†ç å’Œå¯†é’¥

### 6. å®šæœŸå¤‡ä»½

```bash
# å¤‡ä»½ Gitea æ•°æ®
docker exec sidifensen-gitea tar -czf /tmp/gitea-backup.tar.gz /data
```

---

## ğŸ“ æœ€ä½³å®è·µ

1. **ä½¿ç”¨ç§æœ‰ä»“åº“**ï¼šä¿æŠ¤ä»£ç å®‰å…¨
2. **é…ç½® Webhook**ï¼šå®ç°è‡ªåŠ¨è§¦å‘
3. **å®šæœŸå¤‡ä»½**ï¼šé˜²æ­¢æ•°æ®ä¸¢å¤±
4. **ä½¿ç”¨ HTTPS**ï¼šåŠ å¯†ä¼ è¾“
5. **é™åˆ¶è®¿é—®**ï¼šåªå…è®¸æˆæƒç”¨æˆ·

---

## ğŸ‰ å®Œæˆï¼

ç°åœ¨ä½ å·²ç»é…ç½®å¥½äº† Gitea ç§æœ‰ä»“åº“å’Œ Jenkins é›†æˆï¼Œå¯ä»¥ï¼š

1. âœ… æ¨é€ä»£ç åˆ°ç§æœ‰ä»“åº“
2. âœ… è‡ªåŠ¨è§¦å‘ Jenkins éƒ¨ç½²
3. âœ… å®Œå…¨æŒæ§ä»£ç ä»“åº“

å¼€å§‹ä½¿ç”¨å§ï¼ğŸš€

